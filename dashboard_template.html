<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narrative Capture Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 80px;
            background: linear-gradient(180deg, #4a5568 0%, #2d3748 100%);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 8px;
            margin: 5px 10px;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 10px;
            text-align: center;
            line-height: 1.2;
        }

        /* Header */
        .header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .logo {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: #f7fafc;
            border-radius: 20px;
            padding: 8px 15px;
            min-width: 300px;
        }

        .search-bar input {
            border: none;
            background: transparent;
            outline: none;
            margin-left: 10px;
            width: 100%;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow: auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            padding: 30px;
            height: calc(100vh - 70px);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #718096;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3182ce;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Narrative Trends Card */
        .trends-card {
            position: relative;
        }

        .chart-container {
            height: 200px;
            position: relative;
        }

        /* Alert Section */
        .alert {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .alert-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #c53030;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .alert-content {
            color: #2d3748;
            font-size: 14px;
        }

        .alert-meta {
            color: #718096;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Narrative Briefing Card */
        .briefing-date {
            color: #718096;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .representative-pots {
            margin-bottom: 20px;
        }

        .pot-header {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .news-source {
            display: inline-flex;
            align-items: center;
            background: #2b6cb0;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .narrative-text {
            color: #4a5568;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .hashtags {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .hashtag {
            color: #3182ce;
            font-size: 12px;
        }

        .avatars {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #cbd5e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .keywords-section {
            margin-bottom: 20px;
        }

        .keywords-title {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .keyword {
            background: #edf2f7;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
        }

        /* Clustering Card */
        .clustering-container {
            height: 250px;
            position: relative;
        }

        .stance-detection {
            margin-top: 20px;
            font-size: 14px;
            color: #718096;
        }

        /* Spreaders Section */
        .spreaders-list {
            margin-top: 15px;
        }

        .spreader-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .spreader-item:last-child {
            border-bottom: none;
        }

        .spreader-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #cbd5e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .spreader-info {
            flex: 1;
        }

        .spreader-name {
            font-weight: 600;
            color: #2d3748;
        }

        .spreader-desc {
            font-size: 12px;
            color: #718096;
        }

        .spreader-arrow {
            color: #cbd5e0;
        }

        /* World Map */
        .world-map-card {
            grid-column: 1 / -1;
        }

        .map-container {
            height: 300px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .map-dots {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .map-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .map-dot:hover {
            transform: scale(1.3);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                padding: 15px;
            }
            
            .search-bar {
                min-width: 200px;
            }
        }

        /* Data refresh indicator */
        .last-updated {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #718096;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="nav-item active">
                <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                </svg>
                <div class="nav-label">Narrative<br>Trends</div>
            </div>
            
            <div class="nav-item">
                <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
                <div class="nav-label">Briefing</div>
            </div>
            
            <div class="nav-item">
                <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <div class="nav-label">Network</div>
            </div>
            
            <div class="nav-item">
                <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                </svg>
                <div class="nav-label">Spreaders</div>
            </div>
        </div>

        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <button class="menu-btn">‚ò∞</button>
                    <div class="logo">NARRATIVE CAPTURE</div>
                    <div class="search-bar">
                        <svg width="16" height="16" fill="#718096" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input type="text" placeholder="search narrative..." id="searchInput">
                    </div>
                </div>
                <div class="header-right">
                    <svg class="header-icon" fill="#718096" viewBox="0 0 24 24">
                        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                    </svg>
                    <svg class="header-icon" fill="#718096" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="dashboard-grid">
                <!-- Narrative Trends Card -->
                <div class="card trends-card">
                    <div class="card-title">Narrative Trends</div>
                    <div class="chart-container">
                        <div class="loading" id="trendsLoading">
                            <div class="spinner"></div>
                        </div>
                        <canvas id="trendsChart" style="display: none;"></canvas>
                    </div>
                    
                    <div class="alert" id="alertSection" style="display: none;">
                        <div class="alert-header">
                            ‚ö†Ô∏è Alert
                        </div>
                        <div class="alert-content" id="alertContent">
                            <div class="alert-meta" id="alertMeta"></div>
                        </div>
                    </div>
                </div>

                <!-- Narrative Briefing Card -->
                <div class="card" id="briefingCard">
                    <div class="card-title">Narrative Briefing</div>
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Narrative Clustering Card -->
                <div class="card">
                    <div class="card-title">Narrative Clustering</div>
                    <div class="clustering-container">
                        <div class="loading" id="clusterLoading">
                            <div class="spinner"></div>
                        </div>
                        <canvas id="clusterChart" style="display: none;"></canvas>
                    </div>
                    <div class="stance-detection">Stance Detection</div>
                    
                    <div class="keywords-section">
                        <div class="keywords-title">Top Spreaders</div>
                        <div class="narrative-text" style="font-size: 14px; color: #718096;">
                            Loading spreader data...
                        </div>
                        <div class="spreaders-list" id="clusterSpreaders">
                        </div>
                    </div>
                </div>

                <!-- World Map Card -->
                <div class="card world-map-card">
                    <div class="map-container" id="worldMap">
                        <!-- Map dots will be added by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="last-updated" id="lastUpdated">
        Last updated: Loading...
    </div>

    <script>
        // Global variables to store data
        let analysisData = [];
        let narrativeSummaries = [];
        let dynamicKeywords = [];
        
        // Initialize dashboard
        async function initDashboard() {
            try {
                await loadData();
                createTrendsChart();
                createClusterChart();
                populateBriefingCard();
                createWorldMap();
                updateLastUpdated();
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showErrorState();
            }
        }

        // Load data from CSV files generated by Python backend
        async function loadData() {
            try {
                // Try to load the main analysis data
                const analysisResponse = await fetch('enhanced_narrative_intelligence_complete_analysis.csv');
                if (analysisResponse.ok) {
                    const analysisText = await analysisResponse.text();
                    analysisData = Papa.parse(analysisText, { header: true, dynamicTyping: true }).data;
                }

                // Try to load narrative summaries
                const summariesResponse = await fetch('enhanced_narrative_intelligence_narrative_summaries.csv');
                if (summariesResponse.ok) {
                    const summariesText = await summariesResponse.text();
                    narrativeSummaries = Papa.parse(summariesText, { header: true, dynamicTyping: true }).data;
                }

                // Try to load dynamic keywords
                const keywordsResponse = await fetch('enhanced_narrative_intelligence_dynamic_keywords.csv');
                if (keywordsResponse.ok) {
                    const keywordsText = await keywordsResponse.text();
                    dynamicKeywords = Papa.parse(keywordsText, { header: true, dynamicTyping: true }).data;
                }

                console.log('Data loaded successfully:', {
                    analysis: analysisData.length,
                    summaries: narrativeSummaries.length,
                    keywords: dynamicKeywords.length
                });

            } catch (error) {
                console.error('Error loading data:', error);
                // Use fallback mock data if CSV files are not available
                useFallbackData();
            }
        }

        // Fallback mock data if CSV files are not available
        function useFallbackData() {
            console.log('Using fallback mock data...');
            analysisData = generateMockAnalysisData();
            narrativeSummaries = generateMockSummaryData();
            dynamicKeywords = generateMockKeywordData();
        }

        // Create narrative trends chart with real data
        function createTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            // Process temporal data from analysisData
            const timeSeriesData = processTimeSeriesData();
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeSeriesData.labels,
                    datasets: timeSeriesData.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: '#f1f5f9'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + 'k';
                                },
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });

            // Show chart and hide loading
            document.getElementById('trendsLoading').style.display = 'none';
            document.getElementById('trendsChart').style.display = 'block';

            // Show alert if there are significant spikes
            checkForAlerts(timeSeriesData);
        }

        // Process time series data from backend
        function processTimeSeriesData() {
            if (analysisData.length === 0) {
                // Return mock data if no real data available
                return {
                    labels: ['Mar 1', 'Mar 15', 'Apr 1', 'Apr 15', 'Apr 1', 'May 1'],
                    datasets: [
                        {
                            data: [0.5, 0.7, 0.8, 0.9, 1.8, 0.9],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 0,
                            borderWidth: 2
                        }
                    ]
                };
            }

            // Group data by date and cluster
            const dateGroups = {};
            analysisData.forEach(row => {
                if (row.Date && row.Cluster_Consensus !== undefined) {
                    const date = new Date(row.Date).toISOString().split('T')[0];
                    if (!dateGroups[date]) dateGroups[date] = {};
                    const cluster = row.Cluster_Consensus;
                    if (!dateGroups[date][cluster]) dateGroups[date][cluster] = 0;
                    dateGroups[date][cluster]++;
                }
            });

            // Create time series datasets
            const labels = Object.keys(dateGroups).sort().slice(-30); // Last 30 days
            const clusterIds = [...new Set(analysisData.map(row => row.Cluster_Consensus))].filter(id => id >= 0);
            const colors = ['#8b5cf6', '#06b6d4', '#f59e0b', '#ef4444', '#10b981', '#f472b6'];
            
            const datasets = clusterIds.slice(0, 5).map((clusterId, index) => ({
                data: labels.map(date => (dateGroups[date] && dateGroups[date][clusterId]) ? dateGroups[date][clusterId] / 1000 : 0),
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                borderWidth: 2
            }));

            return { labels: labels.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })), datasets };
        }

        // Check for significant spikes and show alerts
        function checkForAlerts(timeSeriesData) {
            const alertSection = document.getElementById('alertSection');
            const alertContent = document.getElementById('alertContent');
            const alertMeta = document.getElementById('alertMeta');

            // Find largest narrative cluster from summaries
            if (narrativeSummaries.length > 0) {
                const topNarrative = narrativeSummaries.reduce((max, current) => 
                    (current.size > max.size) ? current : max
                );

                if (topNarrative && topNarrative.size > 50) { // Threshold for alert
                    alertContent.innerHTML = `<strong>Sudden increase detected in the ${topNarrative.narrative_description || 'major narrative'}</strong>`;
                    alertMeta.textContent = `Spike observed with ${topNarrative.size} articles`;
                    alertSection.style.display = 'block';
                }
            }
        }

        // Create clustering visualization with real data
        function createClusterChart() {
            const ctx = document.getElementById('clusterChart').getContext('2d');
            
            const clusterData = processClusterData();
            
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: clusterData
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                display: false
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Show chart and hide loading
            document.getElementById('clusterLoading').style.display = 'none';
            document.getElementById('clusterChart').style.display = 'block';

            // Populate spreaders list
            populateClusterSpreaders();
        }

        // Process cluster data for visualization
        function processClusterData() {
            if (analysisData.length === 0) {
                // Generate mock cluster data
                const mockData = [];
                const colors = ['#3b82f6', '#06b6d4', '#f59e0b', '#ef4444'];
                
                for (let i = 0; i < 4; i++) {
                    const clusterPoints = [];
                    for (let j = 0; j < 25; j++) {
                        clusterPoints.push({
                            x: Math.random() * 100 + i * 25,
                            y: Math.random() * 100 + i * 25
                        });
                    }
                    mockData.push({
                        label: `Cluster ${i + 1}`,
                        data: clusterPoints,
                        backgroundColor: colors[i],
                        borderColor: colors[i],
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                }
                return mockData;
            }

            // Process real clustering data
            const clusterGroups = {};
            analysisData.forEach(row => {
                const cluster = row.Cluster_Consensus;
                if (cluster >= 0) {
                    if (!clusterGroups[cluster]) clusterGroups[cluster] = [];
                    clusterGroups[cluster].push({
                        x: Math.random() * 100 + (cluster % 5) * 20, // Spread clusters horizontally
                        y: Math.random() * 100,
                        sentiment: row.Sentiment_Label,
                        article: row.Title
                    });
                }
            });

            const colors = ['#3b82f6', '#06b6d4', '#f59e0b', '#ef4444', '#10b981', '#f472b6'];
            
            return Object.entries(clusterGroups).slice(0, 6).map(([clusterId, points], index) => ({
                label: `Cluster ${clusterId}`,
                data: points,
                backgroundColor: colors[index % colors.length],
                borderColor: colors[index % colors.length],
                pointRadius: 4,
                pointHoverRadius: 6
            }));
        }

        // Populate briefing card with real data
        function populateBriefingCard() {
            const briefingCard = document.getElementById('briefingCard');
            
            if (narrativeSummaries.length === 0) {
                // Show fallback content
                briefingCard.innerHTML = `
                    <div class="card-title">Narrative Briefing</div>
                    <div class="briefing-date">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                    <div class="representative-pots">
                        <div class="pot-header">Representative pots</div>
                        <div class="news-source">euronews</div>
                        <div class="narrative-text">
                            Support for the EU's digital sovereignty is rising rapidly. üîÑ
                        </div>
                        <div class="hashtags">
                            <span class="hashtag">#Europa</span>
                            <span class="hashtag">#DigitalSovereignty</span>
                        </div>
                        <div class="avatars">
                            <div class="avatar">EU</div>
                            <div class="avatar">DS</div>
                        </div>
                    </div>
                    <div class="keywords-section">
                        <div class="keywords-title">Keywords</div>
                        <div class="keywords">
                            <span class="keyword">EU</span>
                            <span class="keyword">digital</span>
                            <span class="keyword">sovereignty</span>
                            <span class="keyword">technology</span>
                        </div>
                    </div>
                    <div class="keywords-section">
                        <div class="keywords-title">Top Spreaders</div>
                        <div class="narrative-text" style="font-size: 14px; color: #718096;">
                            EU digital sovereignty narrative
                        </div>
                        <div class="spreaders-list">
                            <div class="spreader-item">
                                <div class="spreader-avatar">CW</div>
                                <div class="spreader-info">
                                    <div class="spreader-name">chrisch wiecha</div>
                                    <div class="spreader-desc">EU digital sovereignty</div>
                                </div>
                                <div class="spreader-arrow">></div>
                            </div>
                            <div class="spreader-item">
                                <div class="spreader-avatar">MM</div>
                                <div class="spreader-info">
                                    <div class="spreader-name">Milosz Matuschek</div>
                                    <div class="spreader-desc">Ebergsorg/LEAI</div>
                                </div>
                                <div class="spreader-arrow">></div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Use real data from narrativeSummaries
            const topNarrative = narrativeSummaries.reduce((max, current) => 
                (current.size > max.size) ? current : max
            );

            const keywords = topNarrative.dynamic_keywords ? 
                topNarrative.dynamic_keywords.split(',').slice(0, 4) : 
                ['analysis', 'narrative', 'intelligence', 'data'];

            const hashtags = keywords.map(keyword => `#${keyword.trim().replace(/\s+/g, '')}`);

            briefingCard.innerHTML = `
                <div class="card-title">Narrative Briefing</div>
                <div class="briefing-date">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                <div class="representative-pots">
                    <div class="pot-header">Representative pots</div>
                    <div class="news-source">analysis</div>
                    <div class="narrative-text">
                        ${topNarrative.narrative_description || 'Major narrative cluster identified with significant activity.'} üîÑ
                    </div>
                    <div class="hashtags">
                        ${hashtags.slice(0, 3).map(tag => `<span class="hashtag">${tag}</span>`).join('')}
                    </div>
                    <div class="avatars">
                        ${keywords.slice(0, 2).map(keyword => 
                            `<div class="avatar">${keyword.charAt(0).toUpperCase()}</div>`
                        ).join('')}
                    </div>
                </div>
                <div class="keywords-section">
                    <div class="keywords-title">Keywords</div>
                    <div class="keywords">
                        ${keywords.map(keyword => 
                            `<span class="keyword">${keyword.trim()}</span>`
                        ).join('')}
                    </div>
                </div>
                <div class="keywords-section">
                    <div class="keywords-title">Top Spreaders</div>
                    <div class="narrative-text" style="font-size: 14px; color: #718096;">
                        ${topNarrative.narrative_type || 'Main narrative'} (${topNarrative.size} articles)
                    </div>
                    <div class="spreaders-list" id="briefingSpreaders">
                        <!-- Will be populated by populateTopSpreaders -->
                    </div>
                </div>
            `;

            populateTopSpreaders('briefingSpreaders');
        }

        // Populate spreaders lists with real data
        function populateTopSpreaders(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Extract top journalists from analysisData
            const journalistCounts = {};
            analysisData.forEach(row => {
                if (row.Journalists_List) {
                    let journalists = [];
                    try {
                        journalists = typeof row.Journalists_List === 'string' ? 
                            JSON.parse(row.Journalists_List.replace(/'/g, '"')) : 
                            row.Journalists_List;
                    } catch (e) {
                        journalists = row.Journalists_List.toString().split(',');
                    }
                    
                    journalists.forEach(journalist => {
                        if (journalist && journalist.trim() && journalist !== 'nan') {
                            const name = journalist.trim();
                            journalistCounts[name] = (journalistCounts[name] || 0) + 1;
                        }
                    });
                }
            });

            const topJournalists = Object.entries(journalistCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);

            if (topJournalists.length === 0) {
                // Fallback spreaders
                container.innerHTML = `
                    <div class="spreader-item">
                        <div class="spreader-avatar">CW</div>
                        <div class="spreader-info">
                            <div class="spreader-name">chrisch wiecha</div>
                            <div class="spreader-desc">EU digital sovereignty</div>
                        </div>
                        <div class="spreader-arrow">></div>
                    </div>
                    <div class="spreader-item">
                        <div class="spreader-avatar">MM</div>
                        <div class="spreader-info">
                            <div class="spreader-name">Milosz Matuschek</div>
                            <div class="spreader-desc">Narrative analysis</div>
                        </div>
                        <div class="spreader-arrow">></div>
                    </div>
                `;
                return;
            }

            container.innerHTML = topJournalists.map(([name, count]) => {
                const initials = name.split(' ').map(n => n.charAt(0).toUpperCase()).join('').slice(0, 2);
                return `
                    <div class="spreader-item">
                        <div class="spreader-avatar">${initials}</div>
                        <div class="spreader-info">
                            <div class="spreader-name">${name}</div>
                            <div class="spreader-desc">${count} articles published</div>
                        </div>
                        <div class="spreader-arrow">></div>
                    </div>
                `;
            }).join('');
        }

        // Populate cluster spreaders
        function populateClusterSpreaders() {
            populateTopSpreaders('clusterSpreaders');
        }

        // Create world map with activity dots
        function createWorldMap() {
            const mapContainer = document.getElementById('worldMap');
            
            // Generate dots based on data or use default positions
            const dots = generateMapDots();
            
            dots.forEach(dot => {
                const dotElement = document.createElement('div');
                dotElement.className = 'map-dot';
                dotElement.style.left = dot.left;
                dotElement.style.top = dot.top;
                dotElement.title = dot.info || 'Narrative activity';
                mapContainer.appendChild(dotElement);
            });
        }

        // Generate map dots based on data or default positions
        function generateMapDots() {
            // Try to extract geographic info from data
            const basePositions = [
                { left: '15%', top: '30%', info: 'North America' },
                { left: '25%', top: '25%', info: 'Western Europe' },
                { left: '35%', top: '35%', info: 'Central Europe' },
                { left: '45%', top: '40%', info: 'Eastern Europe' },
                { left: '55%', top: '20%', info: 'Russia' },
                { left: '65%', top: '45%', info: 'Middle East' },
                { left: '75%', top: '35%', info: 'Asia' },
                { left: '20%', top: '60%', info: 'South America' },
                { left: '30%', top: '70%', info: 'Africa' },
                { left: '50%', top: '65%', info: 'Indian Ocean' },
                { left: '70%', top: '55%', info: 'Southeast Asia' },
                { left: '80%', top: '25%', info: 'East Asia' }
            ];

            return basePositions;
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const lastUpdated = document.getElementById('lastUpdated');
            lastUpdated.textContent = `Last updated: ${new Date().toLocaleString()}`;
        }

        // Show error state if data loading fails
        function showErrorState() {
            document.querySelectorAll('.loading').forEach(loading => {
                loading.innerHTML = `
                    <div style="text-align: center; color: #e53e3e;">
                        <p>‚ö†Ô∏è Error loading data</p>
                        <small>Check if CSV files exist or refresh page</small>
                    </div>
                `;
            });
        }

        // Search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                // Implement search filtering here
                filterNarratives(query);
            });
        }

        // Filter narratives based on search
        function filterNarratives(query) {
            if (!query) return;
            
            // Filter and highlight relevant narratives
            const filteredSummaries = narrativeSummaries.filter(summary => 
                summary.narrative_description?.toLowerCase().includes(query) ||
                summary.dynamic_keywords?.toLowerCase().includes(query)
            );

            // Update displays with filtered results
            console.log('Filtered narratives:', filteredSummaries);
        }

        // Generate mock data for fallback
        function generateMockAnalysisData() {
            const mockData = [];
            const journalists = ['John Smith', 'Maria Garcia', 'Ahmed Hassan', 'Li Wei', 'Sarah Johnson'];
            const clusters = [0, 1, 2, 3, 4];
            const sentiments = ['positive', 'negative', 'neutral'];
            
            for (let i = 0; i < 1000; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                
                mockData.push({
                    Date: date.toISOString(),
                    Title: `News Article ${i + 1}`,
                    Cluster_Consensus: clusters[Math.floor(Math.random() * clusters.length)],
                    Journalists_List: [journalists[Math.floor(Math.random() * journalists.length)]],
                    Sentiment_Label: sentiments[Math.floor(Math.random() * sentiments.length)],
                    Full_Text: `This is the content of article ${i + 1}...`
                });
            }
            return mockData;
        }

        function generateMockSummaryData() {
            return [
                {
                    cluster_id: 0,
                    size: 150,
                    narrative_description: "EU digital sovereignty narrative gaining momentum",
                    dynamic_keywords: "EU, digital, sovereignty, technology",
                    narrative_type: "Policy Discussion"
                },
                {
                    cluster_id: 1,
                    size: 120,
                    narrative_description: "Economic recovery discussions in post-pandemic era",
                    dynamic_keywords: "economy, recovery, growth, pandemic",
                    narrative_type: "Economic Analysis"
                }
            ];
        }

        function generateMockKeywordData() {
            return [
                { cluster_id: 0, keyword: "digital", score: 0.95 },
                { cluster_id: 0, keyword: "sovereignty", score: 0.87 },
                { cluster_id: 1, keyword: "economy", score: 0.92 }
            ];
        }

        // Navigation functionality
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Here you could implement view switching
                    const section = this.querySelector('.nav-label').textContent.trim().split('\n')[0];
                    console.log('Switched to section:', section);
                });
            });
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
            setupSearch();
            setupNavigation();
            
            // Set up auto-refresh every 5 minutes
            setInterval(() => {
                loadData().then(() => {
                    updateLastUpdated();
                    console.log('Data refreshed');
                });
            }, 5 * 60 * 1000);
        });

        // Add click animation to map dots
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('map-dot')) {
                e.target.style.transform = 'scale(1.5)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
            }
        });
    </script>
</body>
</html>